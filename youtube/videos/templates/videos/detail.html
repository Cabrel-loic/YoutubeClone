{% extends "base.html" %}
{% load static %}

{% block title %}{{ video.title }} - Youtube Clone{% endblock title %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/videos.css' %}">
    <link rel="stylesheet" href="{% static 'css/videoplayer.css' %}">
{% endblock extra_css %}

{% block content %}
<div class="video-player-container">
    <div class="video-player">
        <video src="{{ video.streaming_url }}" id="video-player" controls preload="none" poster="{{ video.display_thumbnail_url }}"></video>
        <div id="video-error" class="video-error" style="display: none;"></div>
        <span class="error-icon">‚ö†</span>
        <p>Video Unavailable</p>
        <small>This video file could not be loaded.</small>
    </div>
</div>

<div class="video-details">
    <h1>{{ video.title }}</h1>
    <div class="video-stats">
        <span class="video-stats-left">{{ video.views }} views | {{ video.created_at|date:"M d, Y" }}</span>
        <div class="video-actions">
            <button class="vote-btn" {% if user_vote == 1 %}active{% endif %} data-vote="like" onclick='vote({{ video.id }}, "like")'>
                üëç  <span id="like-count-{{ video.id }}">{{ video.likes }}</span>
            </button>
            <button class="vote-btn" {% if user_vote == -1 %}active{% endif %} data-vote="dislike" onclick='vote({{ video.id }}, "dislike")'>
                üëé  <span id="dislike-count-{{ video.id }}">{{ video.dislikes }}</span>
            </button>

        </div>
    </div>
    <div class="video-channel">
        <div class="channel-avatar">{{ video.user.username|slice:":1" }}</div>
        <a href="{% url 'videos:channel' username=video.user.username %}" class="channel-name">{{ video.user.username }}</a>
        {% if video.description %}
            <p class="video-description">{{ video.description }}</p>
        {% endif %}
        {% if request.user == video.user %}
            <div class="video-owner-actions">
                <button class="delete-btn" type="button" onclick="deleteVideo({{ video.id }})">Delete</button>
            </div>
        {% endif %}
    </div>
</div>
{% endblock content %}

{% block extra_js %}
    <!-- <script src="{% static 'js/vote.js' %}"></script>
    <script src="{% static 'js/videoplayer.js' %}"></script> -->
    <script>
        const videoPlayer = document.getElementById('video-player');
        const videoError = document.getElementById('video-error');

        videoPlayer.addEventListener('error', () => {
            videoPlayer.style.display = 'none';
            videoError.style.display = 'flex';
        });

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrf = ('{{ csrf_token }}' && '{{ csrf_token }}' !== 'None') ? '{{ csrf_token }}' : getCookie('csrftoken')

        function deleteVideo(video_id) {
            if (!confirm('Are you sure you want to delete this video?')) return
            const url = "{% url 'videos:delete' video.id %}";
            fetch(url, {
                method: "POST",
                headers: {
                    "X-CSRFToken": csrf,
                },
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) window.location.href = "{% url 'videos:list' %}"
                    else alert(data.error || "Failed to delete")
                })
                .catch(() => alert('Failed to delete'))
        }

        function vote(videoId, voteType) {
            {% if not user.is_authenticated %}
            window.location.href = '{% url "accounts:login" %}';
            return;
            {% endif %}

            fetch(`/${videoId}/vote/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded", "X-CSRFToken": csrf
                },
                body: `vote=${voteType}`
            })
            .then(r => r.json())
            .then(data => {
                document.getElementById(`like-count-${videoId}`).textContent = data.likes
                document.getElementById(`dislike-count-${videoId}`).textContent = data.dislikes
                document.querySelectorAll(".vote-btn").forEach(btn => btn.classList.remove('active'))
                if (data.user_vote === 1) document.querySelector('[data-vote="like"]').classList.add('active')
                else if (data.user_vote === -1) document.querySelector('[data-vote="dislike"]').classList.add('active')
            })
        }
    </script>
{% endblock extra_js %}